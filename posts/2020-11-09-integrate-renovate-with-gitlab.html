<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Integrate Renovate with GitLab | wxsm&#39;s space</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" size="200x200" href="favicon-iphone.png">
    <link rel="alternate" type="application/rss+xml" href="https://wxsm.space/rss.xml" title="wxsm&#39;s space RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://wxsm.space/feed.atom" title="wxsm&#39;s space Atom Feed">
    <link rel="alternate" type="application/json" href="https://wxsm.space/feed.json" title="wxsm&#39;s space JSON Feed">
    <meta name="description" content="Just another personal blog.">
    <meta name="google-site-verification" content="ekuL5J7xK1IdFtP13v3KxpuGKnYS1oCT9PvZdjYm8Eg">
    
    <link rel="preload" href="/assets/css/0.styles.0b73a1a5.css" as="style"><link rel="preload" href="/assets/js/app.fab3b8de.js" as="script"><link rel="preload" href="/assets/js/4.1a33f30a.js" as="script"><link rel="preload" href="/assets/js/1.89483f76.js" as="script"><link rel="preload" href="/assets/js/134.b11ea62d.js" as="script"><link rel="prefetch" href="/assets/js/10.0671f719.js"><link rel="prefetch" href="/assets/js/100.146c27af.js"><link rel="prefetch" href="/assets/js/101.c4d2a7b0.js"><link rel="prefetch" href="/assets/js/102.5c648c3b.js"><link rel="prefetch" href="/assets/js/103.5cf3bb45.js"><link rel="prefetch" href="/assets/js/104.df80217e.js"><link rel="prefetch" href="/assets/js/105.4c276bde.js"><link rel="prefetch" href="/assets/js/106.776821d5.js"><link rel="prefetch" href="/assets/js/107.9a683c3c.js"><link rel="prefetch" href="/assets/js/108.a9e1e9ab.js"><link rel="prefetch" href="/assets/js/109.4c2cf710.js"><link rel="prefetch" href="/assets/js/11.fa0980a1.js"><link rel="prefetch" href="/assets/js/110.bed88bec.js"><link rel="prefetch" href="/assets/js/111.0a101f49.js"><link rel="prefetch" href="/assets/js/112.4516970c.js"><link rel="prefetch" href="/assets/js/113.cd1ea48e.js"><link rel="prefetch" href="/assets/js/114.561bb901.js"><link rel="prefetch" href="/assets/js/115.46ac757f.js"><link rel="prefetch" href="/assets/js/116.88bf84e3.js"><link rel="prefetch" href="/assets/js/117.5898d9b0.js"><link rel="prefetch" href="/assets/js/118.6f603946.js"><link rel="prefetch" href="/assets/js/119.b0b764d7.js"><link rel="prefetch" href="/assets/js/12.b0adcf58.js"><link rel="prefetch" href="/assets/js/120.28a3d4ef.js"><link rel="prefetch" href="/assets/js/121.b47d6875.js"><link rel="prefetch" href="/assets/js/122.8b74d65a.js"><link rel="prefetch" href="/assets/js/123.79f29c90.js"><link rel="prefetch" href="/assets/js/124.34765e7b.js"><link rel="prefetch" href="/assets/js/125.f5ecb52f.js"><link rel="prefetch" href="/assets/js/126.61c28415.js"><link rel="prefetch" href="/assets/js/127.ee9dd110.js"><link rel="prefetch" href="/assets/js/128.747398de.js"><link rel="prefetch" href="/assets/js/129.cb6a4c79.js"><link rel="prefetch" href="/assets/js/13.1858e5ea.js"><link rel="prefetch" href="/assets/js/130.8018cb46.js"><link rel="prefetch" href="/assets/js/131.f12451fa.js"><link rel="prefetch" href="/assets/js/132.e3797761.js"><link rel="prefetch" href="/assets/js/133.51c20f62.js"><link rel="prefetch" href="/assets/js/135.6da3e8d7.js"><link rel="prefetch" href="/assets/js/136.ec23d400.js"><link rel="prefetch" href="/assets/js/137.ee3ee086.js"><link rel="prefetch" href="/assets/js/14.30623d81.js"><link rel="prefetch" href="/assets/js/15.e2293de2.js"><link rel="prefetch" href="/assets/js/16.64fc67db.js"><link rel="prefetch" href="/assets/js/17.68b70cf8.js"><link rel="prefetch" href="/assets/js/18.e27d09ee.js"><link rel="prefetch" href="/assets/js/19.7ff2d463.js"><link rel="prefetch" href="/assets/js/20.8575e892.js"><link rel="prefetch" href="/assets/js/21.ed4abe24.js"><link rel="prefetch" href="/assets/js/22.c208332a.js"><link rel="prefetch" href="/assets/js/23.f3309544.js"><link rel="prefetch" href="/assets/js/24.9dde0951.js"><link rel="prefetch" href="/assets/js/25.523c6fc4.js"><link rel="prefetch" href="/assets/js/26.29985405.js"><link rel="prefetch" href="/assets/js/27.6afd9b3d.js"><link rel="prefetch" href="/assets/js/28.e3983c0e.js"><link rel="prefetch" href="/assets/js/29.6f6f4623.js"><link rel="prefetch" href="/assets/js/30.aaae0a31.js"><link rel="prefetch" href="/assets/js/31.d881e386.js"><link rel="prefetch" href="/assets/js/32.5c09a21d.js"><link rel="prefetch" href="/assets/js/33.fdd5d475.js"><link rel="prefetch" href="/assets/js/34.f440c0e1.js"><link rel="prefetch" href="/assets/js/35.48f33d1d.js"><link rel="prefetch" href="/assets/js/36.460cc513.js"><link rel="prefetch" href="/assets/js/37.4309f596.js"><link rel="prefetch" href="/assets/js/38.e21c19f2.js"><link rel="prefetch" href="/assets/js/39.9e99cc16.js"><link rel="prefetch" href="/assets/js/40.da38203e.js"><link rel="prefetch" href="/assets/js/41.64cba4ba.js"><link rel="prefetch" href="/assets/js/42.f4cc458d.js"><link rel="prefetch" href="/assets/js/43.2dc21e49.js"><link rel="prefetch" href="/assets/js/44.5e69afc7.js"><link rel="prefetch" href="/assets/js/45.3958b434.js"><link rel="prefetch" href="/assets/js/46.f6bb84f5.js"><link rel="prefetch" href="/assets/js/47.0af47eb5.js"><link rel="prefetch" href="/assets/js/48.b62e6ee9.js"><link rel="prefetch" href="/assets/js/49.bef8a6c8.js"><link rel="prefetch" href="/assets/js/5.3bcab57c.js"><link rel="prefetch" href="/assets/js/50.717be370.js"><link rel="prefetch" href="/assets/js/51.2841b0ce.js"><link rel="prefetch" href="/assets/js/52.33c67ce8.js"><link rel="prefetch" href="/assets/js/53.55bc66da.js"><link rel="prefetch" href="/assets/js/54.c818405b.js"><link rel="prefetch" href="/assets/js/55.eb418195.js"><link rel="prefetch" href="/assets/js/56.0fb1e484.js"><link rel="prefetch" href="/assets/js/57.94fb9d24.js"><link rel="prefetch" href="/assets/js/58.4677b2d8.js"><link rel="prefetch" href="/assets/js/59.384387d6.js"><link rel="prefetch" href="/assets/js/6.cae0ff11.js"><link rel="prefetch" href="/assets/js/60.891278b1.js"><link rel="prefetch" href="/assets/js/61.9ae9010b.js"><link rel="prefetch" href="/assets/js/62.92c14765.js"><link rel="prefetch" href="/assets/js/63.35b5211a.js"><link rel="prefetch" href="/assets/js/64.5e78fc61.js"><link rel="prefetch" href="/assets/js/65.804cafa2.js"><link rel="prefetch" href="/assets/js/66.3e94daaa.js"><link rel="prefetch" href="/assets/js/67.d1340258.js"><link rel="prefetch" href="/assets/js/68.a5306257.js"><link rel="prefetch" href="/assets/js/69.16301972.js"><link rel="prefetch" href="/assets/js/7.3ac6269f.js"><link rel="prefetch" href="/assets/js/70.da93e134.js"><link rel="prefetch" href="/assets/js/71.ea4da371.js"><link rel="prefetch" href="/assets/js/72.fb32315f.js"><link rel="prefetch" href="/assets/js/73.900a7086.js"><link rel="prefetch" href="/assets/js/74.ccc27b2a.js"><link rel="prefetch" href="/assets/js/75.9eb7036c.js"><link rel="prefetch" href="/assets/js/76.ab0621ff.js"><link rel="prefetch" href="/assets/js/77.01b6d49b.js"><link rel="prefetch" href="/assets/js/78.f0f810f7.js"><link rel="prefetch" href="/assets/js/79.5c1aa6a7.js"><link rel="prefetch" href="/assets/js/8.55b06485.js"><link rel="prefetch" href="/assets/js/80.23bc6f03.js"><link rel="prefetch" href="/assets/js/81.d7a6fbf3.js"><link rel="prefetch" href="/assets/js/82.065aad4c.js"><link rel="prefetch" href="/assets/js/83.91144019.js"><link rel="prefetch" href="/assets/js/84.e8708a65.js"><link rel="prefetch" href="/assets/js/85.47080c2b.js"><link rel="prefetch" href="/assets/js/86.52ce7f11.js"><link rel="prefetch" href="/assets/js/87.52e47c76.js"><link rel="prefetch" href="/assets/js/88.f0d64580.js"><link rel="prefetch" href="/assets/js/89.f7b6394f.js"><link rel="prefetch" href="/assets/js/9.bad3ab49.js"><link rel="prefetch" href="/assets/js/90.02d504db.js"><link rel="prefetch" href="/assets/js/91.520ecdbf.js"><link rel="prefetch" href="/assets/js/92.f3913c11.js"><link rel="prefetch" href="/assets/js/93.5aee393f.js"><link rel="prefetch" href="/assets/js/94.25d76f8a.js"><link rel="prefetch" href="/assets/js/95.d1750aec.js"><link rel="prefetch" href="/assets/js/96.a928bf2e.js"><link rel="prefetch" href="/assets/js/97.0e880a1f.js"><link rel="prefetch" href="/assets/js/98.b9a3fa2b.js"><link rel="prefetch" href="/assets/js/99.3afa5cc1.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.407c587a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0b73a1a5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-37172400><main class="page" data-v-37172400><div class="theme-default-content content__default" data-v-37172400><div class="space-header" data-v-37172400><a href="/" class="home-link router-link-active">wxsm's space</a> <div class="links"><span><a href="/" class="site-link router-link-active">home</a> <span>&nbsp;&nbsp;&middot;&nbsp;&nbsp;</span></span><span><a href="/projects/" class="site-link">projects</a> <span>&nbsp;&nbsp;&middot;&nbsp;&nbsp;</span></span><span><a href="/about/" class="site-link">about</a> <span>&nbsp;&nbsp;&middot;&nbsp;&nbsp;</span></span><span><a href="/links/" class="site-link">links</a> <!----></span></div> <div class="search-box-container"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div> <div class="title" data-v-37172400><h3 data-v-37172400>Nov 09, 2020</h3> <h1 data-v-37172400>Integrate Renovate with GitLab</h1></div> <div class="content__default" data-v-37172400><p><img src="https://static.wxsm.space/others/revonate.png" alt=""></p> <p>企业项目群中往往会有部分代码逻辑需要公用，将其抽离作为公共包发布到私有源的做法是比较优雅的解决方式。但是这么做的话后期需要面临一个问题：<strong>当一个公共依赖包的使用者数量逐渐庞大的时候，如何保证当此包发布新版本时，所有使用者都能尽可能快地得到更新？</strong></p> <p>传统的解决方案：</p> <ol><li>手工对所有项目逐个升级。这种办法相当繁琐，且容易产生遗漏，当项目数量足够庞大的时候，发布一次将会时相当痛苦的体验；</li> <li>在依赖安装时指定版本为 <code>latest</code>。这种办法虽然能保证每次安装时都能得到最新版本，但是却有诸多弊端，如：
<ol><li>无法保证依赖的安全性，有可能一次更新不慎造成大面积的瘫痪；</li> <li>对「依赖锁」不友好，如 <code>yarn.lock</code> 等。</li></ol></li></ol> <p>因此，如何使这个过程变得优雅，是一个亟待解决的问题。</p> <h2 id="关于-renovate"><a href="#关于-renovate" class="header-anchor">#</a> 关于 Renovate</h2> <p><a href="https://github.com/renovatebot/renovate" target="_blank" rel="noopener noreferrer">Renovate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是一个专注于解决依赖问题的库，使用 Node.js 编写，因此它也许会更适合于使用 NPM 或 Yarn 作为依赖管理的项目。我最早从 <a href="https://zexo.dev/posts/2020/03/01/keep-your-repo-dependencies-up-to-date-with-renovate" target="_blank" rel="noopener noreferrer">zexo.dev/使用 renovate 监控第三方依赖更新<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这篇博文中得知了这个工具，在 GitHub 上托管的个人项目上尝试了一段时间后发现它非常好用。</p> <h2 id="如何工作"><a href="#如何工作" class="header-anchor">#</a> 如何工作？</h2> <p>复杂的流程就不讲了。总的来说，它会对启用了它的项目做以下几件事情：</p> <ol><li>发起一个 Onboard PR，将它的配置文件以 PR 的形式合并到项目中。在这个 PR 被合并前，不会有任何后续操作。</li> <li>在 Onboard 被合并后，发起一个 Pin PR，将项目中用到的依赖的版本锁定，对于 <code>package.json</code> 来说，即去除任何模糊的通配符，如 <code>^</code> / <code>~</code> 等，改用精确的版本号。在这个 PR 被合并前，不会有任何后续操作。</li> <li>Pin PR 被合并后，开始周期性地检索依赖。当发现有更新时，为每个依赖（或依赖群）更新发起一个 PR，内容包含依赖定义文件（如 <code>package.json</code>） 与依赖锁文件（如 <code>yarn.lock</code>）。</li> <li>如果用户想要做本次升级，将其合并即可。将来如果该依赖再次有更新可用，会再次生成新的 PR；</li> <li>如果用户不想做本次升级，将其关闭即可。Renovate 将忽略该版本，不再发起 PR。</li></ol> <p>以上只是大致流程，实际上 Renovate 还有非常多的配置项可以发掘，可以提供高度定制化的使用体验。</p> <h2 id="如何使用"><a href="#如何使用" class="header-anchor">#</a> 如何使用？</h2> <p>如果是在 GitHub 上使用，只需到应用市场安装 Renovate 并为它提供想要开启服务的项目的访问权限即可，过几分钟就能在项目内收到 Onboard PR。但这部分不是本文的重点。</p> <p>本文重点是如何在私有环境中使用它，即 Self-hosted 环节，与我司的自建 GitLab 进行集成。</p> <p>根据 <a href="https://github.com/renovatebot/renovate/blob/master/docs/usage/self-hosting.md" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，自建 Renovate 服务有以下几种方式：</p> <h3 id="方式-1-npm-install-g-renovate"><a href="#方式-1-npm-install-g-renovate" class="header-anchor">#</a> 方式 1：<code>npm install -g renovate</code></h3> <p>该方式最简便，只需要安装了 Node.js 环境以后，通过以上 cli 工具即可实现所有功能。但是官方文档对他的描述十分简略，几乎没有，勉强通过 <code>--help</code> 才试出了用法：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">GITHUB_COM_TOKEN</span><span class="token operator">=</span>your-github-token renovate <span class="token punctuation">\</span>
    --platform<span class="token operator">=</span>gitlab <span class="token punctuation">\</span>
    --endpoint<span class="token operator">=</span>https://gitlab.cpmpany.com/api/v4/ <span class="token punctuation">\</span>
    --token<span class="token operator">=</span>your-gitlab-token <span class="token punctuation">\</span>
    --onboarding<span class="token operator">=</span>true <span class="token punctuation">\</span>
    --onboarding-config<span class="token operator">=</span><span class="token string">&quot;{<span class="token entity" title="\&quot;">\&quot;</span>extends<span class="token entity" title="\&quot;">\&quot;</span>: [<span class="token entity" title="\&quot;">\&quot;</span>config:base<span class="token entity" title="\&quot;">\&quot;</span>]}&quot;</span> <span class="token punctuation">\</span>
    --log-level<span class="token operator">=</span>debug <span class="token punctuation">\</span>
    --yarnrc<span class="token operator">=</span><span class="token string">&quot;registry <span class="token entity" title="\&quot;">\&quot;</span>http://npm-registry.cpmpany.com<span class="token entity" title="\&quot;">\&quot;</span>&quot;</span> <span class="token punctuation">\</span>
    --npmrc<span class="token operator">=</span><span class="token string">&quot;registry=<span class="token entity" title="\&quot;">\&quot;</span>http://npm-registry.cpmpany.com<span class="token entity" title="\&quot;">\&quot;</span>&quot;</span> <span class="token punctuation">\</span>
    path/to/project
</code></pre></div><p>解释：</p> <ol><li><code>GITHUB_COM_TOKEN</code> 是用来从 GitHub 上获取 Changelog 时要用到的。如果没有提供这个 token，则 Renovate 不会尝试去获取 Changelog；</li> <li><code>platform</code> / <code>endpoint</code> / <code>token</code> 分别对应目标平台的参数；</li> <li><code>onboarding</code> 表示项目必须先接受 Onboard PR 才会执行后续操作；</li> <li><code>onboarding-config</code> 为 Onboard PR 所提供的默认配置文件；</li> <li><code>log-level</code> 为 <code>debug</code> 时才能得到详细的日志，方便调试；</li> <li>项目内一般自带了 yarnrc 与 npmrc，如果项目内自带的已经覆盖了私有源则无需配置，否则需要配置。需要注意的是，如果使用 npm 则只需要提供 <code>npmrc</code>，但如果使用 yarn 则需要同时提供 <code>yarnrc</code> 与 <code>npmrc</code>，缺一不可。</li></ol> <p>命令行可以作为本地调试工具，最终部署的话还是直接使用打包好的镜像更好用一些。</p> <h3 id="方式2-使用-docker-镜像"><a href="#方式2-使用-docker-镜像" class="header-anchor">#</a> 方式2：使用 Docker 镜像</h3> <p>Renovate 提供了构建好的 <a href="https://hub.docker.com/r/renovate/renovate/" target="_blank" rel="noopener noreferrer">renovate/renovate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 镜像，可以直接使用。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run --rm -v <span class="token string">&quot;/path/to/your/config.js:/usr/src/app/config.js&quot;</span> renovate/renovate
</code></pre></div><p>这个镜像有多个版本，其中大体区分为 <code>slim</code> 版与完整版。它们之间的区别是：</p> <ol><li>完整版包含了所有可能要用到的构件工具，如 <code>Python</code> 等，约 1.3GB；</li> <li><code>slim</code> 版仅包含 Renovate 自身，约 130MB。</li></ol> <p>可以使用 GitLab CI 与该镜像直接集成，<code>image</code> 指定 <code>renovate/renovate</code> 即可。但是由于 Renovate 是一个需要持续周期性执行的任务，放置在 CI 中略显不合适。因此我选择使用 k8s 集成。</p> <h3 id="方式3-使用-kubernetes"><a href="#方式3-使用-kubernetes" class="header-anchor">#</a> 方式3：使用 Kubernetes</h3> <p><a href="https://github.com/renovatebot/renovate/blob/master/docs/usage/self-hosting.md" target="_blank" rel="noopener noreferrer">官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 贴心地提供了 k8s 的配置样例，基本上复制粘贴就能完成配置了：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> renovate<span class="token punctuation">-</span>env
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
  <span class="token key atrule">GITHUB_COM_TOKEN</span><span class="token punctuation">:</span> <span class="token string">'any-personal-user-token-for-github-com-for-fetching-changelogs'</span>
  <span class="token comment"># set to true to run on all repos you have push access to</span>
  <span class="token key atrule">RENOVATE_AUTODISCOVER</span><span class="token punctuation">:</span> <span class="token string">'false'</span>
  <span class="token key atrule">RENOVATE_ENDPOINT</span><span class="token punctuation">:</span> <span class="token string">'https://github.company.com/api/v3'</span>
  <span class="token key atrule">RENOVATE_GIT_AUTHOR</span><span class="token punctuation">:</span> <span class="token string">'Renovate Bot &lt;bot@renovateapp.com&gt;'</span>
  <span class="token key atrule">RENOVATE_PLATFORM</span><span class="token punctuation">:</span> <span class="token string">'github'</span>
  <span class="token key atrule">RENOVATE_TOKEN</span><span class="token punctuation">:</span> <span class="token string">'your-github-enterprise-renovate-user-token'</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> renovate
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">'@hourly'</span>
  <span class="token key atrule">concurrencyPolicy</span><span class="token punctuation">:</span> Forbid
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> renovate
              <span class="token comment"># Update this to the latest available and then enable Renovate on</span>
              <span class="token comment"># the manifest</span>
              <span class="token key atrule">image</span><span class="token punctuation">:</span> renovate/renovate<span class="token punctuation">:</span>23.19.2
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> user/repo
              <span class="token comment"># Environment Variables</span>
              <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">secretRef</span><span class="token punctuation">:</span>
                    <span class="token key atrule">name</span><span class="token punctuation">:</span> renovate<span class="token punctuation">-</span>env
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
</code></pre></div><p>但是，这里有一个地方比较坑的是，像 <code>RENOVATE_AUTODISCOVER</code> 这种环境变量的命名，官方并没有提供一个文档明确说明到底是以何种规则得到的（或者是我没有找到）。不过经过一番搜索，我找到了它的具体实现：</p> <p><a href="https://github.com/renovatebot/renovate/blob/53ca91301f6a36c0c87e7d6b06b1bd8c9ec1b283/lib/config/env.ts" target="_blank" rel="noopener noreferrer">lib/config/env.ts<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-typescript extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getEnvName</span><span class="token punctuation">(</span>option<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>RenovateOptions<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>env <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> option<span class="token punctuation">.</span>env<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> nameWithUnderscores <span class="token operator">=</span> option<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([A-Z])/g</span><span class="token punctuation">,</span> <span class="token string">'_$1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">RENOVATE_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>nameWithUnderscores<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>也就是，将普通配置名（驼峰命名）：</p> <ol><li>全部转为大写字母；</li> <li>单词首字母前加上 <code>_</code>；</li> <li>前面加上 <code>RENOVATE_</code></li></ol> <p>就得到了环境变量的命名。</p> <p>但是，经过实践发现这里有一个特例：<code>logLevel</code> 这个配置并不是转换为 <code>RENOVATE_LOG_LEVEL</code>，而仅仅是 <code>LOG_LEVEL</code> 而已。</p> <p>另外，官方提供的样例对于所有 secrets 都使用了 <code>stringData</code> 来储存，不提倡这种做法。我建议将 <code>token</code> 类密钥信息做 base64 编码储存在 <code>data</code> 中：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> renovate<span class="token punctuation">-</span>secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">GITHUB_COM_TOKEN</span><span class="token punctuation">:</span> <span class="token punctuation">...</span>
  <span class="token key atrule">RENOVATE_TOKEN</span><span class="token punctuation">:</span> <span class="token punctuation">...</span>
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
  <span class="token key atrule">RENOVATE_AUTODISCOVER</span><span class="token punctuation">:</span> <span class="token string">'false'</span>
  <span class="token key atrule">RENOVATE_ENDPOINT</span><span class="token punctuation">:</span> <span class="token string">'https://gitlab.company.com/api/v4/'</span>
  <span class="token key atrule">RENOVATE_PLATFORM</span><span class="token punctuation">:</span> <span class="token string">'gitlab'</span>
  <span class="token key atrule">RENOVATE_ONBOARDING</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
  <span class="token key atrule">RENOVATE_ONBOARDING_CONFIG</span><span class="token punctuation">:</span> <span class="token string">'{...}'</span>
  <span class="token key atrule">RENOVATE_SEMANTIC_COMMITS</span><span class="token punctuation">:</span> <span class="token string">'enabled'</span>
  <span class="token key atrule">RENOVATE_YARNRC</span><span class="token punctuation">:</span> <span class="token string">'registry &quot;http://npm-registry.company.com&quot;'</span>
  <span class="token key atrule">RENOVATE_NPMRC</span><span class="token punctuation">:</span> <span class="token string">'registry=&quot;http://npm-registry.company.com&quot;'</span>
  <span class="token key atrule">LOG_LEVEL</span><span class="token punctuation">:</span> <span class="token string">'debug'</span>
</code></pre></div><h2 id="集成-gitlab"><a href="#集成-gitlab" class="header-anchor">#</a> 集成 GitLab</h2> <p>在之前的博文 <a href="/posts/2020-09-23-gitlab-ce-code-review-bot.html">Gitlab CE Code-Review Bot</a> 中，我介绍了 GitLab CE 评审机器人的实现。由于 Renovate 也是基于 Merge Request 实现的，因此它们能够很好地相处：</p> <ol><li>Renovate 发起 MR</li> <li>评审机器人随机分派评审人</li> <li>评审通过，合并</li></ol> <p>但是有几点需要注意：</p> <ol><li>由于评审机器人使用了 <code>WIP</code> 来阻止 MR 被手动合并，因此 Renovate 的配置中也需要将 MR 设置为 draft 状态，这样才能维持 MR 的 <code>WIP</code> 标记。否则，Renovate 会在发起 MR 后的第二次扫描中尝试去除 MR 的 <code>WIP</code> 标记；</li> <li>最好给 Renovate 开设一个独立的账号。如果与其他用户或程序共用账号，Renovate 可能会在 force-push 的过程中使某些由其它用户做出的改动丢失；</li> <li>因为 Renovate 的设计中存在一些高危操作（分支删除，强制推送等），因此最好只赋予 Developer 权限。实际上如果不启用自动合并，它也只需要 Developer 权限。</li></ol> <p>符合我需求的最终配置 <code>renovate.json</code>：</p> <div class="language-json5 extra-class"><pre class="language-json5"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;extends&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;config:base&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 除了 peerDependencies 以外所有依赖都 pin</span>
    <span class="token string">&quot;:pinAllExceptPeerDependencies&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 仅启用 npm 依赖管理，项目里有其它依赖项不想被 Renovate 管理的，</span>
  <span class="token comment">// 如：Docker / Gradle / Cocoa Pod 等</span>
  <span class="token property">&quot;enabledManagers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;npm&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 仅对 @company/ 开头的私有包启用依赖管理，其它外部依赖一律禁用</span>
  <span class="token property">&quot;packageRules&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;packagePatterns&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;*&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;excludePackagePatterns&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;^@company/&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;enabled&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 将 MR 标记为 draft，即 WIP</span>
  <span class="token property">&quot;draftPR&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="遇到的问题"><a href="#遇到的问题" class="header-anchor">#</a> 遇到的问题</h2> <ol><li>将 Renovate 部署上 Kubernetes 的时候，要注意能够分配的节点是否都有私有源的访问权限。如果 CronJob 被分配到了无权访问的节点会导致私有包 Lookup Failed，从而更新失败。如果只有部分节点拥有访问权限，可以用 <code>nodeSelector</code> 或 <code>nodeName</code> 指定节点；</li> <li>Changelog 在 GitLab (10.3.2) 上面会丢失格式，如图所示：<img src="https://static.wxsm.space/blog/98614561-a5fc1f00-2333-11eb-8c9e-3d33107cd7ec.png" alt="screenshot">
这个问题猜测是由于我司的 GitLab 版本过低导致的。因为 <a href="http://gitlab.com/" target="_blank" rel="noopener noreferrer">gitlab.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (13.x) 上不存在这个问题。但是因为 GitLab 不在我的管辖范围内，因此目前没有找到很好的解决方案，后续如果解决了会更新。</li></ol></div> <br data-v-37172400> <div class="last-updated" data-v-37172400><span class="prefix" data-v-37172400>Last Updated:</span> <span class="time" data-v-37172400>about 2 months ago</span></div>  <div class="space-footer" data-v-a298b7ba data-v-37172400><p class="footer-text" data-v-a298b7ba>© 2021 wxsm</p> <p class="footer-text" data-v-a298b7ba>
    Powered by <a href="https://vuepress.vuejs.org/" target="_blank" data-v-a298b7ba>VuePress</a>
     · 
    Theme by <a href="https://github.com/wxsms/vuepress-theme-mini" target="_blank" data-v-a298b7ba>mini</a></p></div></div></main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.fab3b8de.js" defer></script><script src="/assets/js/4.1a33f30a.js" defer></script><script src="/assets/js/1.89483f76.js" defer></script><script src="/assets/js/134.b11ea62d.js" defer></script>
  </body>
</html>
